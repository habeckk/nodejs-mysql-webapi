<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    
    <title>APF</title>
</head>
<body>
    
    <div class="header">
        <h1>FERRAMENTARIA</h1>
        <button class="LOGO0" type="button" onclick="carregarValores()">
            <img src="/img/logoDocol.png" alt="Imagem 3D">
        </button> 

        <button class="LOGOLogin" type="button" onclick="carregarValores0()">
            <img id="INFO1" class="imagem" src="" alt="imagem">
        </button> 

        <div class="sidebar-buttons-container">
            <button class="sidebar-button" type="button" onclick="openForm0()">Abrir O.S</button>
            <button class="sidebar-button" id="viewCardsBtn">Visualizar como Cartões</button>
            <button class="sidebar-button" id="viewListBtn">Visualizar como Lista</button>
        </div>
    </div>

    <!-- Formulário sobreposto -->
    <div class="overlay" id="overlay0">
        <div class="modal">
            <h2>Apontamento</h2>
            <form id="formNovoApont0">
                <label for="Ordem">Número da Ordem:</label>
                <input type="text" id="Ordem" name="Ordem"><br>     
                
                <label for="operacao">Número da Operação:</label>
                <input type="text" id="operacao" name="operacao"><br>                   
                
                <label for="operador">ID Operador:</label>
                <input type="text" id="operador" name="operador"><br>        

                <label for="turno">Turno:</label>
                <select id="turno" name="turno"></select><br>

                <label for="observacao">Observação:</label>
                <textarea id="observacao" name="observacao"></textarea><br>
                
                <button type="submit">Salvar</button>
                <button type="button" onclick="closeForm0()">Cancelar</button>
            </form>
        </div>
    </div>

    <div class="overlay" id="overlay1">
        <div class="modal">
            <h2>Apontamento</h2>
            <form id="formNovoApont1">
                <div class="hour">
                    <label for="dt-inicio">Data Inicio:</label>
                    <input type="date" id="dt-inicio" name="dt-inicio"><br>
                    
                    <label for="hr-inicio">Horário Inicio:</label>
                    <input type="time" id="hr-inicio" name="hr-inicio"><br>

                    <label for="hr-fim">Horário Fim:</label>
                    <input type="time" id="hr-fim" name="hr-fim"><br>
                </div>
                
                <label for="hr-fim">Finalizado:</label>
                <div class="switch">
                    <input type="checkbox" id="switch" /><label for="switch"></label>
                </div>
                <label for="observacao">Observação:</label>
                <textarea id="observacao" name="observacao"></textarea><br>
                
                <button type="submit">Salvar</button>
                <button type="button" onclick="closeForm1()">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="pedidosContainer"></div>

    <script>
        document.getElementById('Ordem').addEventListener('keydown', function(event) {
            if (event.key === "Enter" || event.keyCode === 13) {
                event.preventDefault(); // Previne a ação padrão do "Enter"

                this.value.trim();

                const form = this.form;
                const index = Array.prototype.indexOf.call(form, this);
                const nextInput = form.elements[index + 1];
                if (nextInput) {
                    nextInput.focus();
                }
            }
        });
        
        //-------------------------------------------------------------------------
        const BASE_URL = 'http://localhost:5500';
        //-------------------------------------------------------------------------
        // Rota para adicionar um nova O.S
        //-------------------------------------------------------------------------
        document.getElementById('formNovoApont0').addEventListener('submit', async function(event) {
            // Evite que o formulário seja enviado automaticamente
            event.preventDefault();

            // Verifique se todos os campos obrigatórios foram preenchidos antes de enviar o formulário
            const Ordem = document.getElementById('Ordem').value;
            const operacao = document.getElementById('operacao').value;
            const operador = document.getElementById('operador').value;
            const turno = document.getElementById('turno').value;
            const obs = document.getElementById('observacao').value;
            // Verifique se algum dos campos obrigatórios está vazio
            if (!Ordem || !operacao || !operador || !turno ) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return; // Pare a execução se algum campo estiver vazio
            }

            const novoSetup = {
                login: "login",
                n_op: Ordem,
                n_ope: operacao,
                n_user: operador,
                n_tur: turno.charAt(0),
                trab_real: "1",
                uni_trab: "H",
                conf_final:"",
                data_lanc: "",
                data_ini: "",
                hora_ini: "",
                data_fim: "",
                hora_fim: "",
                status: "Aguardando",
                obs: obs
            };

            console.log(turno.charAt(0))

            try {
                const response = await fetch(`${BASE_URL}/ferr_apont`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novoSetup)
                });

                const data = await response.json();
                console.log('Resposta do servidor:', data);

                showSuccessMessage('4');

                closeForm();
                //atualizarDados();
                
            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
            }
        });
        //-------------------------------------------------------------------------
        // Rota para adicionar um novo apontamento
        //-------------------------------------------------------------------------
        document.getElementById('formNovoApont1').addEventListener('submit', async function(event) {
            console.log("1")
            event.preventDefault();
            const target = event.target;
            console.log("2")

                    const dtinicio = document.getElementById('dt-inicio').value;
                    const hrinicio = document.getElementById('hr-inicio').value;
                    const hrfim = document.getElementById('hr-fim').value;
                    const conf_final = document.getElementById('switch').checked ? "Sim" : "Não"; // Exemplo de coleta para o switch
                    const obs = document.getElementById('observacao').value;
                
                    if (!dtinicio || !hrinicio || !hrfim) {
                        alert('Por favor, preencha todos os campos obrigatórios.');
                        return;
                    }
                
                    const novoSetup = {
                        conf_final,
                        data_lanc: dtinicio,
                        data_ini: dtinicio,
                        hora_ini: hrinicio,
                        data_fim: dtinicio, // Ajuste conforme necessário
                        hora_fim: hrfim,
                        status: "Finalizado",
                        obs
                    };
                


                        console.log("3")

                            console.log("4")
                            const id = "13"; // Armazena o ID
                            console.log(id)
                            
                            try {
                                const response = await fetch(`${BASE_URL}/ferr_apont/${id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(novoSetup)
                                });
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    console.log('Resposta do servidor:', data);
                                    showSuccessMessage('4'); // Assumindo que esta função exibe uma mensagem de sucesso
                                    closeForm1(); // Fechar o formulário/modal
                                    // atualizarDados(); // Se houver necessidade de atualizar a visualização dos dados na página
                                } else {
                                    throw new Error('Falha na atualização do apontamento');
                                }
                            } catch (error) {
                                console.error('Erro ao enviar solicitação:', error);
                            }
                        
                      
                 
        });
        //-------------------------------------------------------------------------
        // Rota para carregar dados apontados
        //-------------------------------------------------------------------------

        function renderizarComoCartoes(data) {
            fetch(`${BASE_URL}/ferr_apont`)
                .then(response => response.json())
                .then(data => {
                    //data.sort((a, b) => {
                        // Converta as horas para objetos Date para que possam ser comparados
                        //const horaA = new Date(`1970-01-01T${a.horario}`);
                        //const horaB = new Date(`1970-01-01T${b.horario}`);

                        // Compare as horas e retorne o resultado da comparação
                        //return horaA - horaB;
                    //});
                    // Limpe o conteúdo do contêiner antes de adicionar novos elementos
                    const pedidosContainer = document.getElementById('pedidosContainer');
                    pedidosContainer.innerHTML = '';

                    // Itere sobre os dados recebidos e crie um cartão para cada solicitação
                    data.forEach(solicitacao => {
                        // Cria um novo elemento div para representar o cartão
                        const card = document.createElement('div');
                        card.classList.add('card1');

                        // Crie um novo elemento div para representar o conteúdo do cartão
                        const cardContent = document.createElement('div');
                        cardContent.classList.add('card-content');      
                        cardContent.innerHTML = `
                                            <button class="menu-button">Menu</button>
                                            <div class="status-buttons">       
                                                <button class="button-apontamento"onclick="openForm1()">Apontamento</button>
                                                <button class="button-finalizar">Finalizar</button>
                                            </div>

                                            <form id="formAlterarSetup">
                                                <div class="infoId">
                                                    <div><label class="info-line">${solicitacao.Id}</p></label ></div>
                                                </div>

                                                <div class="info0">
                                                    <div class="linha-separadora"></div> 
                                                    <div><label class="texto1">Ordem de Serviço</label></div>  
                                                    <div><label class="info-line">${solicitacao.n_op}</p></label ></div>
                                                    
                                                    <div class="linha-separadora"></div> 
                                                    <div><label class="texto1">Operação</label></div>  
                                                    <div><label class="info-line">${solicitacao.n_ope}</p></label ></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Nº Usuário</label></div>  
                                                    <div><label class="info-line item">${solicitacao.n_user}</p></label ></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Horas Trabalhadas</label></div>  
                                                    <div><label class="info-line">${solicitacao.trab_real}</p></label ></div>
                                                    
                                                    <!-- Adicione a linha abaixo para o elemento de status -->
                                                    <div class="linha-separadora"></div>    
                                                    <div class="objeto-card status"><label class="texto1">Status:</label></div>  
                                                    <div class="objeto-card status"><label class="info-line">${solicitacao.status}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Confirmação final:</label></div>  
                                                    <div><label class="info-line">${solicitacao.conf_final}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Lote:</label></div>  
                                                    <div><label class="info-line">${solicitacao.data_lanc}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Observacao:</label></div>  
                                                    <div><label class="info-line1">${solicitacao.obs}</label></div>
                                                </div>
                                        </form>
                                        `;
                                        // Adicione o conteúdo do cartão ao cartão
                                        card.appendChild(cardContent);

                                        // Adicione o cartão ao contêiner de pedidos
                                        pedidosContainer.appendChild(card);

                                        // Aplique a classe de status ao cartão
                                        card.classList.add(`status-${solicitacao.status.toLowerCase()}`);
                                    });
                                })
                                .catch(error => {
                                    console.error('Erro ao buscar dados do servidor:', error);
                                });
        }

        document.getElementById('viewCardsBtn').addEventListener('click', () => {
            fetch(`${BASE_URL}/ferr_apont`)
                .then(response => response.json())
                .then(data => renderizarComoCartoes(data));
        });
        
        document.getElementById('viewListBtn').addEventListener('click', () => {
            fetch(`${BASE_URL}/ferr_apont`)
                .then(response => response.json())
                .then(data => renderizarComoLista(data));
        });

        window.addEventListener('load', function() {
            atualizarDados();
            console.log("teste")
            showSuccessMessage('1');
            // Atualize os dados a cada 5 minutos
            setInterval(atualizarDados, 0.5 * 60 * 1000); // 5 minutos * 60 segundos * 1000 milissegundos
        });

        //-------------------------------------------------------------------------        

        function atualizarDados() {
            fetch(`${BASE_URL}/ferr_apont`)//ferr_apont
                .then(response => response.json())
                .then(data => {
                    const pedidosContainer = document.getElementById('pedidosContainer');
                    pedidosContainer.innerHTML = ''; // Limpa o contêiner atual
                    renderizarComoCartoes(data); // Esta função agora apenas cria os elementos, não busca dados   
                });
        }

        //-------------------------------------------------------------------------
        function renderizarComoLista(data) {
            const pedidosContainer = document.getElementById('pedidosContainer');
            pedidosContainer.innerHTML = ''; // Limpa o contêiner
        
            // Cria a tabela e o cabeçalho
            const tabela = document.createElement('table');
            tabela.innerHTML = `<thead>
                                    <tr>
                                        <th>Id</th>
                                        <th>Nº O.S</th>
                                        <th>Nº Oper.</th>
                                        <th>Usuário</th>
                                        <th>Turno</th>
                                        <th>Tempo Trab.</th>
                                        <th>Un.</th>
                                        <th>Coclu.</th>
                                        <th>Data Lanç.</th>
                                        <th>Data Inic.</th>
                                        <th>Hora Inic.</th>
                                        <th>Data Fim</th>
                                        <th>Hora Fim</th>
                                        <th>Status</th>
                                        <th>Observação</th>
                                    </tr>
                                </thead>`;
            const tbody = document.createElement('tbody');
        
            data.forEach(solicitacao => {
                const row = document.createElement('tr');
                // Aplica a classe de cor baseada no status da solicitação
                row.className = `status-${solicitacao.status.toLowerCase()}`;
                row.innerHTML = `<td>${solicitacao.Id}</td>
                                <td>${solicitacao.n_op}</td>
                                <td>${solicitacao.n_ope}</td>
                                <td>${solicitacao.n_user}</td>
                                <td>${solicitacao.n_tur}</td>
                                <td>${solicitacao.trab_real}</td>
                                <td>${solicitacao.uni_trab}</td>
                                <td>${solicitacao.conf_final}</td>
                                <td>${solicitacao.data_lanc}</td>
                                <td>${solicitacao.data_ini}</td>
                                <td>${solicitacao.hora_ini}</td>
                                <td>${solicitacao.data_fim}</td>
                                <td>${solicitacao.hora_fim}</td>
                                <td>${solicitacao.status}</td>
                                <td>${solicitacao.obs}</td>`;
                tbody.appendChild(row);
            });
        
            tabela.appendChild(tbody);
            pedidosContainer.appendChild(tabela);
        }

        //-------------------------------------------------------------------------
        // Adicione um evento de clique para cada botão de status
        //-------------------------------------------------------------------------

        function openForm0() {
            document.getElementById("overlay0").style.display = "block";
            // Selecione o formulário pelo ID ou outra referência, se necessário
            const form = document.getElementById("overlay0"); // Substitua "meuFormulario" pelo ID do seu formulário
            const firstInput = form.querySelector("input"); // Isso selecionará o primeiro elemento input do formulário
            if (firstInput) {
                firstInput.focus();
            }
        }

        function openForm1() {
            document.getElementById("overlay1").style.display = "block";
        }

        function closeForm0() {
            document.getElementById("overlay0").style.display = "none";
        }

        function closeForm1() {
            document.getElementById("overlay1").style.display = "none";
        }
        
        fetch('/json/data.json')
        .then(response => response.json())
        .then(data => {
            // Chama uma função para preencher os campos do formulário com os dados do JSON
            preencherCamposFormulario(data);
        })
        .catch(error => {
            console.error('Erro ao carregar arquivo JSON:', error);
        });
    
        function preencherCamposFormulario(data) {    
            // Preenche o campo de operação com os dados do JSON
            const operacaoSelect = document.getElementById('turno');
            data.Turno.forEach(op => {
                const option = document.createElement('option');
                option.value = op;
                option.textContent = op;
                operacaoSelect.appendChild(option);
            });
        }

        window.addEventListener('load', function() {
            showSuccessMessage('3');
        });

        window.onload = function() {
            const agora = new Date();
            
            // Formatando a data para YYYY-MM-DD
            const dataAtual = agora.toISOString().split('T')[0];
            
            // Formatando a turno para HH:MM
            const turnoAtual = agora.toTimeString().split(' ')[0].substring(0, 5);

            // Definindo os valores dos campos de data e turno
            document.getElementById('dt-inicio').value = dataAtual;
            document.getElementById('hr-inicio').value = turnoAtual;

            // Para o horário de fim, você pode querer definir um valor padrão
            // ou calcular um tempo futuro. Exemplo: Adicionando 1 turno ao horário atual
            //const umaturnoMaisTarde = new Date(agora.getTime() + 60*60*1000);
            //const turnoFim = umaturnoMaisTarde.toTimeString().split(' ')[0].substring(0, 5);
            //document.getElementById('hr-fim').value = turnoFim;
        }

    </script>

    <link rel="stylesheet" href="/css/public.css">
    <link rel="stylesheet" href="/css/APF.css">
    <script src="/js/PUBLIC.JS"></script>

</body>
</html>