<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    
    <title>SSU</title>
</head>
<body>
    
    <div class="header">
        <div class="LOGO1">
            <a href="/html/Menu.html">
                <img src="/img/Usinagem/Sem título.png" alt="Imagem 3D">
            </a>
        </div>
        <h1>SETUP USINAGEM</h1>
        <div class="sidebar-buttons-container">
            <button class="sidebar-button" type="button" onclick="openForm()">Solicitar Setup</button>
            <button class="sidebar-button" type="button" onclick="MostrarLista()">Mostrar Lista</button>
            <button class="sidebar-button" type="button" onclick="MostrarGrade()">Mostrar Grade</button>
        </div>
    </div>

    <!-- HTML para a mensagem de sucesso -->
    <div id="successMessage" class="success-message">
        <img src="/img/icons8-ok.svg" alt="Imagem de Sucesso" class="success-image">
        <div class="success-text">Página Atualizada com Sucesso!</div>
    </div>


    <div class="linha-separadora1"></div>

    <!-- Formulário sobreposto -->
    <div class="overlay" id="overlay">
        <div class="modal">
            <h2>Solicitação de Setup</h2>
            <form id="formNovoSetupUsi">
                <label for="centro-custo">Centro de Custo:</label>
                <select id="centro-custo" name="centro-custo"></select><br>
                
                <label for="maquina">Máquina:</label>
                <select id="maquina" name="maquina"></select><br>                
                
                <label for="item">Item:</label>
                <input type="text" id="item" name="item"><br>
                
                <label for="hora">Hora:</label>
                <input type="time" id="hora" name="hora"><br>
                
                <label for="operacao">Operação:</label>
                <select id="operacao" name="operacao"></select><br>
                
                <label for="lote">Lote:</label>
                <input type="text" id="lote" name="lote"><br>
                
                <label for="observacao">Observação:</label>
                <textarea id="observacao" name="observacao"></textarea><br>
                
                <button type="submit">Solicitar</button>
                <button type="button" onclick="closeForm()">Cancelar</button>
            </form>
        </div>
    </div>
    <div id="pedidosContainer"></div>
    <!-- Restante do seu HTML -->
    <div class="container1">   
        <div class="scroll-wrapper">
            <div id="pedidosContainer" class="card-container">
                <!-- Cartões serão adicionados aqui dinamicamente -->
            </div>    
        </div>
    </div>

    <div id="agendamentosContainer1"></div>

    <script>
//-------------------------------------------------------------------------
        const BASE_URL = 'http://localhost:5500';
//-------------------------------------------------------------------------

// Defina a função para atualizar os dados
        function atualizarDados() {
            // Faça uma solicitação fetch para a rota /setupusi
            fetch(`${BASE_URL}/setupusi`)
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => {
                        // Converta as horas para objetos Date para que possam ser comparados
                        const horaA = new Date(`1970-01-01T${a.horario}`);
                        const horaB = new Date(`1970-01-01T${b.horario}`);

                        // Compare as horas e retorne o resultado da comparação
                        return horaA - horaB;
                    });
                    // Limpe o conteúdo do contêiner antes de adicionar novos elementos
                    const pedidosContainer = document.getElementById('pedidosContainer');
                    pedidosContainer.innerHTML = '';

                    // Itere sobre os dados recebidos e crie um cartão para cada solicitação
                    data.forEach(solicitacao => {
                        // Cria um novo elemento div para representar o cartão
                        const card = document.createElement('div');
                        card.classList.add('card');

                        // Crie um novo elemento div para representar o conteúdo do cartão
                        const cardContent = document.createElement('div');
                        cardContent.classList.add('card-content');

                        // Defina o conteúdo do cartão com base nos dados da solicitação
                        cardContent.innerHTML = `

                                            <button class="menu-button">Menu</button>
                                            <div class="status-buttons">
                                                <button class="button-aguardando">Aguardando</button>
                                                <button class="button-atendendo">Atendendo</button>
                                                <button class="button-pronto">Pronto</button>
                                                <button class="button-cancelado">Cancelado</button>
                                                <button class="button-folha">Folha Processo</button>
                                                <button class="button-fip">FIP</button>
                                                <button class="button-excluir">Excluir</button>
                                            </div>

                                            <form id="formAlterarSetup">
                                                <div class="infoId">
                                                    <div><label class="info-line">${solicitacao.Id}</p></label ></div>
                                                </div>

                                                <div class="info0">

                                                    <div class="linha-separadora"></div> 
                                                    <div><label class="texto1">CentroCusto:</label></div>  
                                                    <div><label class="info-line">${solicitacao.cc}</p></label ></div>
                                                    
                                                    <div class="linha-separadora"></div> 
                                                    <div><label class="texto1">Máquina:</label></div>  
                                                    <div><label class="info-line">${solicitacao.maquina}</p></label ></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Item:</label></div>  
                                                    <div><label class="info-line">${solicitacao.item}</p></label ></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Hora:</label></div>  
                                                    <div><label class="info-line">${solicitacao.horario}</p></label ></div>
                                                    
                                                    <!-- Adicione a linha abaixo para o elemento de status -->
                                                    <div class="linha-separadora"></div>    
                                                    <div class="objeto-card status"><label class="texto1">Status:</label></div>  
                                                    <div class="objeto-card status"><label class="info-line">${solicitacao.status}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Operacao:</label></div>  
                                                    <div><label class="info-line">${solicitacao.operacao}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Lote:</label></div>  
                                                    <div><label class="info-line">${solicitacao.lote}</p></label></div>

                                                    <div class="linha-separadora"></div>    
                                                    <div><label class="texto1">Observacao:</label></div>  
                                                    <div><label class="info-line1">${solicitacao.obs}</label></div>
                                                </div>
                                        </form>
                                        `;
                                        // Adicione o conteúdo do cartão ao cartão
                                        card.appendChild(cardContent);

                                        // Adicione o cartão ao contêiner de pedidos
                                        pedidosContainer.appendChild(card);

                                        // Aplique a classe de status ao cartão
                                        card.classList.add(solicitacao.status.toLowerCase());
                                    });
                                })
                                .catch(error => {
                                    console.error('Erro ao buscar dados do servidor:', error);
                                });
        }

//___________________________________________________________________________________
// Rota para adicionar um novo cliente
//___________________________________________________________________________________
        document.getElementById('formNovoSetupUsi').addEventListener('submit', async function(event) {
            // Evite que o formulário seja enviado automaticamente
            event.preventDefault();

            // Verifique se todos os campos obrigatórios foram preenchidos antes de enviar o formulário
            const centroCusto = document.getElementById('centro-custo').value;
            const maquina = document.getElementById('maquina').value;
            const item = document.getElementById('item').value;
            const hora = document.getElementById('hora').value;
            const operacao = document.getElementById('operacao').value;
            const lote = document.getElementById('lote').value;

            // Verifique se algum dos campos obrigatórios está vazio
            if (!centroCusto || !maquina || !item || !hora || !operacao || !lote) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return; // Pare a execução se algum campo estiver vazio
            }

            // Se todos os campos obrigatórios estiverem preenchidos, continue com o envio do formulário
            const agora = new Date();
            const dia = agora.getDate().toString().padStart(2, '0');
            const mes = (agora.getMonth() + 1).toString().padStart(2, '0');
            const ano = agora.getFullYear();
            const horaAtual = agora.getHours().toString().padStart(2, '0');
            const minutos = agora.getMinutes().toString().padStart(2, '0');
            const segundos = agora.getSeconds().toString().padStart(2, '0');
            const HRpedido = `${dia}/${mes}/${ano} ${horaAtual}:${minutos}:${segundos}`;

            const login = "Fernando Habeck";
            const status = "Aguardando";
            const calibrador = "0";
            const HRfinalizado = "";
            const obs = document.getElementById('observacao').value;

            const novoSetup = {
                HRpedido: HRpedido,
                login: login,
                cc: centroCusto,
                maquina: maquina,
                item: item,
                operacao: operacao,
                lote: lote,
                horario: hora,
                status: status,
                calibrador: calibrador,
                HRfinalizado: HRfinalizado,
                obs: obs
            };

            try {
                const response = await fetch(`${BASE_URL}/setupusi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novoSetup)
                });

                const data = await response.json();
                console.log('Resposta do servidor:', data);

                // Exiba a mensagem de sucesso após o envio bem-sucedido do formulário
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block'; // Exibe a mensagem

                setTimeout(() => {
                    successMessage.style.display = 'none'; // Oculta a mensagem após 2 segundos
                }, 500);

                closeForm();
                atualizarDados();
                
            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
            }
        });

//___________________________________________________________________________________

// Dentro do seu script no HTML
            document.getElementById('pedidosContainer').addEventListener('click', function(event) {
                const target = event.target;
                if (target.classList.contains('button-aguardando') || 
                    target.classList.contains('button-atendendo') || 
                    target.classList.contains('button-pronto') || 
                    target.classList.contains('button-esperando') || 
                    target.classList.contains('button-cancelado')) {
                    
                    const status = target.textContent.trim(); // Obtém o texto do botão, que será o status
                    const card = target.closest('.card');

                    if (card) {
                        const infoLineElement = card.querySelector('.info-line');
                        if (infoLineElement) {
                            const id = infoLineElement.textContent.trim(); // Define a variável id aqui
                            // Faça o que for necessário com o ID aqui

                            // Faça uma solicitação fetch para atualizar o status do setup
                            fetch(`${BASE_URL}/atualizar-status/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ status: status })
                            })
                            .then(response => {
                                if (response.ok) {
                                    console.log(`Status atualizado para ${status} com sucesso.`);
                                    // Recarregue os dados após a atualização do status
                                    atualizarDados();
                                    atualizarDadosEMostrarMensagem();
                                } else {
                                    console.error('Erro ao atualizar o status.');
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao atualizar o status:', error);
                            });
                        } else {
                            console.error('Elemento com a classe .info-line não encontrado.');
                        }
                    } else {
                        console.error('Elemento com a classe .card não encontrado.');
                    }
                } 
            });
//___________________________________________________________________________________
// Excluir setup com sucesso
//___________________________________________________________________________________
            document.getElementById('pedidosContainer').addEventListener('click', async function(event) {
                const target = event.target;
                if (target.classList.contains('button-excluir')) {
                    const card = target.closest('.card');

                    if (card) {
                        const infoLineElement = card.querySelector('.info-line');
                        if (infoLineElement) {
                            const id = infoLineElement.textContent.trim(); // Obtém o ID do setup

                            try {
                                const response = await fetch(`${BASE_URL}/delete/${id}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ id: id })
                                });

                                if (response.ok) {
                                    console.log(`Setup excluído ${id} com sucesso.`);
                                    // Recarregue os dados após a exclusão do setup
                                    atualizarDados();
                                    atualizarDadosEMostrarMensagem();
                                } else {
                                    console.error('Erro ao excluir o setup.');
                                }
                            } catch (error) {
                                console.error('Erro ao excluir o setup:', error);
                            }
                        } else {
                            console.error('Elemento com a classe .info-line não encontrado.');
                        }
                    } else {
                        console.error('Elemento com a classe .card não encontrado.');
                    }
                }
            });
//___________________________________________________________________________________
// Abrir folha de processo
//___________________________________________________________________________________
            document.getElementById('pedidosContainer').addEventListener('click', async function(event) {
            const target = event.target;
            if (target.classList.contains('button-folha')) {
                const card = target.closest('.card');

                if (card) {
                    const infoLineElement = card.querySelector('.info-line');
                    if (infoLineElement) {
                        const id = infoLineElement.textContent.trim(); // Obtém o ID do setup

                        try {
                            // Abra o link desejado com base no ID do setup
                            window.open(`http://172.18.1.10:54451/Reports/Pages/JobReports.aspx?JobId=
        2200`, '_blank');

                            // Aqui você pode adicionar outras operações que deseja realizar após abrir o link
                            console.log(`Link da folha de ${id} aberto com sucesso.`);
                        } catch (error) {
                            console.error('Erro ao abrir o link da folha:', error);
                        }
                    } else {
                        console.error('Elemento com a classe .info-line não encontrado.');
                    }
                } else {
                    console.error('Elemento com a classe .card não encontrado.');
                }
            }
        });
//___________________________________________________________________________________
// Abrir folha de processo
//___________________________________________________________________________________
            document.getElementById('pedidosContainer').addEventListener('click', async function(event) {
            const target = event.target;
            if (target.classList.contains('button-fip')) {
                const card = target.closest('.card');

                if (card) {
                    const infoLineElement = card.querySelector('.info-line');
                    if (infoLineElement) {
                        const id = infoLineElement.textContent.trim(); // Obtém o ID do setup

                        try {
                            // Faz uma solicitação AJAX para obter o arquivo PDF do servidor
                            const response = await fetch(`${BASE_URL}/pdf/${id}`);
                            if (response.ok) {
                                // Se a resposta estiver ok, obtenha o conteúdo do arquivo PDF
                                const blob = await response.blob();
                                const pdfUrl = URL.createObjectURL(blob);

                                // Abre o arquivo PDF em uma nova janela
                                window.open(pdfUrl, '_blank');
                            } else {
                                console.error('Erro ao obter o arquivo PDF:', response.statusText);
                            }
                        } catch (error) {
                            console.error('Erro ao abrir o PDF:', error);
                        }
                    } else {
                        console.error('Elemento com a classe .info-line não encontrado.');
                    }
                } else {
                    console.error('Elemento com a classe .card não encontrado.');
                }
            }
        });

//___________________________________________________________________________________
// Adicione um evento de escuta ao elemento <select> de centro de custo
//___________________________________________________________________________________
            document.getElementById('centro-custo').addEventListener('change', function() {
                // Recupere o valor do centro de custo selecionado
                const centroCustoSelecionado = this.value;

                // Faça uma solicitação fetch para obter as máquinas correspondentes ao centro de custo selecionado
                fetch(`${BASE_URL}/maquinas?centroCusto=${centroCustoSelecionado}`)
                    .then(response => response.json())
                    .then(data => {
                        // Limpe as opções atuais do <select> de máquinas
                        const selectMaquina = document.getElementById('maquina');
                        selectMaquina.innerHTML = '';

                        // Preencha o <select> de máquinas com as opções obtidas
                        data.forEach(maquina => {
                            const option = document.createElement('option');
                            option.value = maquina.Maquina; // Defina o valor da opção como o nome da máquina
                            option.textContent = maquina.Maquina; // Defina o texto visível da opção como o nome da máquina
                            selectMaquina.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao carregar máquinas:', error);
                    });
            });

//___________________________________________________________________________________
// Adicione um evento de clique para cada botão de status
//___________________________________________________________________________________                        
            function openForm() {
                document.getElementById("overlay").style.display = "block";
            }

            function closeForm() {
                document.getElementById("overlay").style.display = "none";
            }
//___________________________________________________________________________________
// Chame a função de atualização quando a página carregar
//___________________________________________________________________________________
            window.addEventListener('load', function() {
                atualizarDados();

                // Atualize os dados a cada 5 minutos
                setInterval(atualizarDados, 1 * 60 * 1000); // 5 minutos * 60 segundos * 1000 milissegundos
            });                

            // Após enviar a solicitação, exiba a mensagem personalizada e oculte-a após 2 segundos
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block'; // Exibe a mensagem

            setTimeout(() => {
                successMessage.style.display = 'none'; // Oculta a mensagem após 2 segundos
            }, 500);

    </script>

    <link rel="stylesheet" href="/css/public.css">
    <link rel="stylesheet" href="/css/SSU.css">
    <script src="/js/SSU.js"></script>

</body>
</html>
