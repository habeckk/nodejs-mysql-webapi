<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <title>Listagem de Agendamentos</title>
</head>
<body>
    
    <div class="header">
        <div class="LOGO1">
            <a href="/html/Menu.html">
                <img src="/img/Usinagem/Sem título.png" alt="Imagem 3D">
            </a>
        </div>
        <div class="LOGO2">
            <img src="/img/docol_logo.png" alt="Imagem 3D">
        </div>
        <h1>Lista de Equipamentos</h1>
        <div class="sidebar-buttons-container">
            <button class="sidebar-button" type="button" onclick="openForm()">Solicitar Setup</button>
            <button class="sidebar-button" type="button" onclick="MostrarLista()">Mostrar Lista</button>
            <button class="sidebar-button" type="button" onclick="MostrarGrade()">Mostrar Grade</button>
        </div>
    </div>
    <div class="linha-separadora1"></div>

    <!-- Formulário sobreposto -->
    <div class="overlay" id="overlay">
        <div class="modal">
            <h2>Solicitação de Setup</h2>
            <form id="formNovoSetupUsi">
                <label for="centro-custo">Centro de Custo:</label>
                <input type="text" id="centro-custo" name="centro-custo"><br>

                <label for="maquina">Máquina:</label>
                <input type="text" id="maquina" name="maquina"><br>

                <label for="item">Item:</label>
                <input type="text" id="item" name="item"><br>

                <label for="hora">Hora:</label>
                <input type="time" id="hora" name="hora"><br>

                <label for="operacao">Operação:</label>
                <select id="operacao" name="operacao">
                    <option value="1">1ª Operação</option>
                    <option value="2">2ª Operação</option>
                    <option value="3">3ª Operação</option>
                </select><br>

                <label for="lote">Lote:</label>
                <input type="text" id="lote" name="lote"><br>

                <label for="observacao">Observação:</label>
                <textarea id="observacao" name="observacao"></textarea><br>

                <button type="submit">Solicitar</button>
                <button type="button" onclick="closeForm()">Cancelar</button>

            </form>
        </div>
    </div>
    <div id="pedidosContainer"></div>
    <!-- Restante do seu HTML -->
    <div class="container1">   
        <div class="scroll-wrapper">
            <div id="pedidosContainer" class="card-container">
                <!-- Cartões serão adicionados aqui dinamicamente -->
            </div>    
        </div>
    </div>

    <div id="agendamentosContainer1"></div>

    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/SolicitarSetupUsinagem.css">

    <script>
// Defina a função para atualizar os dados
function atualizarDados() {
    // Faça uma solicitação fetch para a rota /setupusi
    fetch('http://localhost:5500/setupusi')
        .then(response => response.json())
        .then(data => {
            // Limpe o conteúdo do contêiner antes de adicionar novos elementos
            const pedidosContainer = document.getElementById('pedidosContainer');
            pedidosContainer.innerHTML = '';

            // Itere sobre os dados recebidos e crie um cartão para cada solicitação
            data.forEach(solicitacao => {
                // Cria um novo elemento div para representar o cartão
                const card = document.createElement('div');
                card.classList.add('card');

                // Crie um novo elemento div para representar o conteúdo do cartão
                const cardContent = document.createElement('div');
                cardContent.classList.add('card-content');

                // Defina o conteúdo do cartão com base nos dados da solicitação
                cardContent.innerHTML = `

                                    <button class="menu-button">Menu</button>
                                    <div class="status-buttons">
                                        <button class="button-aguardando">Aguardando</button>
                                        <button class="button-atendendo">Atendendo</button>
                                        <button class="button-concluido">Concluído</button>
                                        <button class="button-cancelado">Cancelado</button>
                                        <button class="button-excluir">Excluir</button>
                                    </div>

                                    <form id="formAlterarSetup">
                                    <div class="info0">
                                        <div><label class="texto1">Id:</label></div>  
                                        <div><label class="info-line">${solicitacao.Id}</p></label ></div>

                                        <div class="linha-separadora"></div> 
                                        <div><label class="texto1">CentroCusto:</label></div>  
                                        <div><label class="info-line">${solicitacao.cc}</p></label ></div>

                                        <div class="linha-separadora"></div>    
                                        <div><label class="texto1">Item:</label></div>  
                                        <div><label class="info-line">${solicitacao.item}</p></label ></div>

                                        <div class="linha-separadora"></div>    
                                        <div><label class="texto1">Hora:</label></div>  
                                        <div><label class="info-line">${solicitacao.horario}</p></label ></div>
                                        
                                        <!-- Adicione a linha abaixo para o elemento de status -->
                                        <div class="linha-separadora"></div>    
                                        <div class="objeto-card status"><label class="texto1">Status:</label></div>  
                                        <div class="objeto-card status"><label class="info-line">${solicitacao.status}</p></label></div>

                                        <div class="linha-separadora"></div>    
                                        <div><label class="texto1">Operacao:</label></div>  
                                        <div><label class="info-line">${solicitacao.operacao}</p></label></div>

                                        <div class="linha-separadora"></div>    
                                        <div><label class="texto1">Lote:</label></div>  
                                        <div><label class="info-line">${solicitacao.lote}</p></label></div>

                                        <div class="linha-separadora"></div>    
                                        <div><label class="texto1">Observacao:</label></div>  
                                        <div><label class="info-line1">${solicitacao.obs}</label></div>
                                    </div>
                                </form>
                                `;
                                // Adicione o conteúdo do cartão ao cartão
                                card.appendChild(cardContent);

                                // Adicione o cartão ao contêiner de pedidos
                                pedidosContainer.appendChild(card);

                                // Aplique a classe de status ao cartão
                                card.classList.add(solicitacao.status.toLowerCase());
                            });
                        })
                        .catch(error => {
                            console.error('Erro ao buscar dados do servidor:', error);
                        });
}

// Chame a função de atualização quando a página carregar
window.addEventListener('load', function() {
    atualizarDados();

    // Atualize os dados a cada 5 minutos
    setInterval(atualizarDados, 5 * 60 * 1000); // 5 minutos * 60 segundos * 1000 milissegundos
});                
//___________________________________________________________________________________
//___________________________________________________________________________________
// Rota para alterar um cliente pelo ID

        //___________________________________________________________________________________
        // Rota para adicionar um novo cliente
        //___________________________________________________________________________________
        document.getElementById('formNovoSetupUsi').addEventListener('submit', async function(event) {
    event.preventDefault();

    const agora = new Date();
    const dia = agora.getDate().toString().padStart(2, '0');
    const mes = (agora.getMonth() + 1).toString().padStart(2, '0');
    const ano = agora.getFullYear();
    const hora = agora.getHours().toString().padStart(2, '0');
    const minutos = agora.getMinutes().toString().padStart(2, '0');
    const segundos = agora.getSeconds().toString().padStart(2, '0');
    const HRpedido = `${dia}/${mes}/${ano} ${hora}:${minutos}:${segundos}`;

    const login = "Fernando Habeck";
    const cc = document.getElementById('centro-custo').value;
    const maquina = document.getElementById('maquina').value;
    const item = document.getElementById('item').value;
    const operacao = document.getElementById('operacao').value;
    const lote = document.getElementById('lote').value;
    const horario = document.getElementById('hora').value;
    const status = "Aguardando";
    const calibrador = "1";
    const HRfinalizado = "";
    const obs = document.getElementById('observacao').value;

    const novoSetup = {
        HRpedido: HRpedido,
        login: login,
        cc: cc,
        maquina: maquina,
        item: item,
        operacao: operacao,
        lote: lote,
        horario: horario,
        status: status,
        calibrador: calibrador,
        HRfinalizado: HRfinalizado,
        obs: obs
    };

    try {
        const response = await fetch('http://localhost:5500/setupusi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(novoSetup)
        });

        const data = await response.json();
        console.log('Resposta do servidor:', data);
        
        // Após enviar a solicitação, atualize os dados para refletir as alterações
        atualizarDados();
    } catch (error) {
        console.error('Erro ao enviar solicitação:', error);
    }
});

//___________________________________________________________________________________

// Dentro do seu script no HTML
document.getElementById('pedidosContainer').addEventListener('click', function(event) {
    const target = event.target;
    if (target.classList.contains('button-aguardando') || 
        target.classList.contains('button-atendendo') || 
        target.classList.contains('button-concluido') || 
        target.classList.contains('button-cancelado')) {
        
        const status = target.textContent.trim(); // Obtém o texto do botão, que será o status
        const card = target.closest('.card');

        if (card) {
            const infoLineElement = card.querySelector('.info-line');
            if (infoLineElement) {
                const id = infoLineElement.textContent.trim(); // Define a variável id aqui
                // Faça o que for necessário com o ID aqui

                // Faça uma solicitação fetch para atualizar o status do setup
                fetch(`http://localhost:5500/atualizar-status/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: status })
                })
                .then(response => {
                    if (response.ok) {
                        console.log(`Status atualizado para ${status} com sucesso.`);
                        // Recarregue os dados após a atualização do status
                        atualizarDados();
                    } else {
                        console.error('Erro ao atualizar o status.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao atualizar o status:', error);
                });
            } else {
                console.error('Elemento com a classe .info-line não encontrado.');
            }
        } else {
            console.error('Elemento com a classe .card não encontrado.');
        }
    } 
});
//___________________________________________________________________________________
// Excluir setup com sucesso
//___________________________________________________________________________________
document.getElementById('pedidosContainer').addEventListener('click', async function(event) {
    const target = event.target;
    if (target.classList.contains('button-excluir')) {
        const card = target.closest('.card');

        if (card) {
            const infoLineElement = card.querySelector('.info-line');
            if (infoLineElement) {
                const id = infoLineElement.textContent.trim(); // Obtém o ID do setup

                try {
                    const response = await fetch(`http://localhost:5500/delete/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: id })
                    });

                    if (response.ok) {
                        console.log(`Setup excluído ${id} com sucesso.`);
                        // Recarregue os dados após a exclusão do setup
                        atualizarDados();
                    } else {
                        console.error('Erro ao excluir o setup.');
                    }
                } catch (error) {
                    console.error('Erro ao excluir o setup:', error);
                }
            } else {
                console.error('Elemento com a classe .info-line não encontrado.');
            }
        } else {
            console.error('Elemento com a classe .card não encontrado.');
        }
    }
});

//___________________________________________________________________________________
// Adicione um evento de clique para cada botão de status
//___________________________________________________________________________________
                    
function openForm() {
    document.getElementById("overlay").style.display = "block";
}

function closeForm() {
    document.getElementById("overlay").style.display = "none";
}
    </script>
</body>
</html>
